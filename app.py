import os
import time
import logging
import requests
from instagrapi import Client
from dotenv import load_dotenv

load_dotenv()

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø¥Ù†Ø³ØªØºØ±Ø§Ù… AI...")

class InstagramBot:
    def __init__(self):
        self.cl = Client()
        self.cohere_api_key = os.getenv('COHERE_API_KEY')
    
    def login(self):
        try:
            username = os.getenv('INSTAGRAM_USERNAME')
            password = os.getenv('INSTAGRAM_PASSWORD')
            
            logger.info("ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...")
            self.cl.login(username, password)
            logger.info("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
            return True
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {e}")
            return False

    def get_ai_response(self, message):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Cohere AI"""
        try:
            url = "https://api.cohere.ai/v1/generate"
            headers = {
                "Authorization": f"Bearer {self.cohere_api_key}",
                "Content-Type": "application/json"
            }
            
            data = {
                "model": "command",
                "prompt": f"Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© ÙˆØ¯ÙˆØ¯Ø©: {message}",
                "max_tokens": 50,
                "temperature": 0.7
            }
            
            response = requests.post(url, json=data, headers=headers, timeout=10)
            
            if response.status_code == 200:
                result = response.json()
                return result['generations'][0]['text'].strip()
            else:
                return "Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„ØªÙƒ! ğŸŒ¸"
        except:
            return "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ˜Š ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ"

    def check_messages(self):
        """ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"""
        try:
            threads = self.cl.direct_threads(limit=5)
            for thread in threads:
                if hasattr(thread, 'unseen_count') and thread.unseen_count > 0:
                    logger.info("ğŸ“© ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©")
                    return True
            return False
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: {e}")
            return False

    def run(self):
        if self.login():
            logger.info("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†! Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...")
            while True:
                try:
                    has_messages = self.check_messages()
                    if has_messages:
                        logger.info("ğŸ¯ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©")
                    time.sleep(30)
                except Exception as e:
                    logger.error(f"ğŸ’¥ Ø®Ø·Ø£: {e}")
                    time.sleep(60)

if __name__ == "__main__":
    bot = InstagramBot()
    bot.run()
